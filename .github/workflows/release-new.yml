name: 📦 Release Spotifix

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type de release'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable
          - nightly

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.ref_name || steps.extract_version.outputs.current_version }}
      COMMIT: ${{ github.event.head_commit.message || 'Manual release' }}
    
    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Extract version from build.gradle.kts (si workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: extract_version
        run: |
          VERSION=$(grep 'val version = ' app/build.gradle.kts | sed 's/.*val version = "\(.*\)".*/\1/')
          echo "Current version in build.gradle.kts: $VERSION"
          echo "current_version=$VERSION" >> $GITHUB_OUTPUT

      - name: ⚙️ Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 17
          cache: 'gradle'

      - name: 🔧 Make gradlew executable
        run: chmod +x ./gradlew

      - name: 🚀 Build with Gradle
        run: |
          if [ "${{ github.event.inputs.release_type }}" = "stable" ] || [ "${{ github.event_name }}" = "push" ]; then
            echo "Building stable APK..."
            ./gradlew assembleStable --no-daemon
            cp app/build/outputs/apk/stable/app-stable-unsigned.apk app/build/v${{ env.VERSION }}.apk
          else
            echo "Building nightly APK..."
            ./gradlew assembleNightly --no-daemon
            cp app/build/outputs/apk/nightly/app-nightly-unsigned.apk app/build/v${{ env.VERSION }}.apk
          fi

      - name: 📤 Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: unsigned_app
          path: app/build/v${{ env.VERSION }}.apk

      - name: 📦 Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name || format('v{0}', steps.extract_version.outputs.current_version) }}
          name: 🚀 Spotifix v${{ env.VERSION }}
          body: |
            ## 🎉 Spotifix v${{ env.VERSION }}
            
            **Commit:** ${{ env.COMMIT }}
            
            ### 📱 Installation
            Téléchargez l'APK ci-dessous et installez-le sur votre appareil Android.
            
            ---
            *Release générée automatiquement* 🤖
          files: app/build/v${{ env.VERSION }}.apk
          generate_release_notes: true
          prerelease: ${{ github.event.inputs.release_type == 'nightly' }}
