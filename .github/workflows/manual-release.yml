name: ğŸ“¦ Auto Release

on:
  workflow_dispatch:
    inputs:
      increment_type:
        description: 'Type d\'incrÃ©mentation'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch   # 0.0.1 -> 0.0.2
        - minor   # 0.0.1 -> 0.1.0
        - major   # 0.0.1 -> 1.0.0
      release_type:
        description: 'Type de release'
        required: true
        default: 'stable'
        type: choice
        options:
        - stable
        - nightly

jobs:
  create-release:
    name: ğŸš€ Create Auto Release
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ” Get latest version
      id: get_version
      run: |
        # RÃ©cupÃ©rer la derniÃ¨re version depuis les tags
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "Latest tag: $LATEST_TAG"
        
        # Extraire le numÃ©ro de version (enlever le 'v')
        CURRENT_VERSION=${LATEST_TAG#v}
        echo "Current version: $CURRENT_VERSION"
        
        # SÃ©parer major.minor.patch
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        
        # IncrÃ©menter selon le type choisi
        case "${{ github.event.inputs.increment_type }}" in
          "major")
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          "minor")
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          "patch")
            PATCH=$((PATCH + 1))
            ;;
        esac
        
        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        echo "New version: $NEW_VERSION"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
    
    - name: ğŸ“ Update version in build.gradle.kts
      run: |
        NEW_VERSION="${{ steps.get_version.outputs.new_version }}"
        sed -i "s/val version = \".*\"/val version = \"$NEW_VERSION\"/" app/build.gradle.kts
        echo "Updated version to $NEW_VERSION in build.gradle.kts"
    
    - name: ğŸ’¾ Commit version update
      run: |
        NEW_VERSION="${{ steps.get_version.outputs.new_version }}"
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add app/build.gradle.kts
        git commit -m "ğŸ”¼ Bump version to $NEW_VERSION"
        git push origin master
    
    - name: ğŸ·ï¸ Create and push tag
      run: |
        NEW_VERSION="${{ steps.get_version.outputs.new_version }}"
        git tag v$NEW_VERSION
        git push origin v$NEW_VERSION
    
    - name: âš™ï¸ Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: ğŸ› ï¸ Setup Gradle
      uses: gradle/gradle-build-action@v3
    
    - name: ğŸ”§ Make gradlew executable
      run: chmod +x ./gradlew
    
    - name: ğŸ—ï¸ Build APK
      run: |
        if [ "${{ github.event.inputs.release_type }}" == "stable" ]; then
          ./gradlew assembleStable
        else
          ./gradlew assembleNightly
        fi
    
    - name: ğŸ“¦ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.new_version }}
        name: ğŸš€ Release ${{ steps.get_version.outputs.new_version }}
        body: |
          ## ğŸ‰ Version ${{ steps.get_version.outputs.new_version }}
          
          **Type d'incrÃ©mentation:** ${{ github.event.inputs.increment_type }}
          **Type de release:** ${{ github.event.inputs.release_type }}
          
          ### ğŸ“± Installation
          TÃ©lÃ©chargez l'APK ci-dessous et installez-la sur votre appareil Android.
          
          ### ğŸ”„ Mise Ã  jour automatique
          Si vous avez dÃ©jÃ  l'app installÃ©e, utilisez la fonction "VÃ©rifier les mises Ã  jour" dans les paramÃ¨tres.
          
          ---
          *Release gÃ©nÃ©rÃ©e automatiquement par GitHub Actions* ğŸ¤–
        files: |
          app/build/outputs/apk/**/*.apk
        draft: false
        prerelease: ${{ github.event.inputs.release_type == 'nightly' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: ğŸ› ï¸ Setup Gradle
      uses: gradle/gradle-build-action@v3
    
    - name: ğŸ”§ Make gradlew executable
      run: chmod +x ./gradlew
    
    - name: ğŸ—ï¸ Build APK
      run: |
        if [ "${{ github.event.inputs.release_type }}" == "stable" ]; then
          ./gradlew assembleStable
        else
          ./gradlew assembleNightly
        fi
    
    - name: ğŸ“¦ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.event.inputs.version }}
        name: Release ${{ github.event.inputs.version }}
        body: |
          ğŸ‰ **Release ${{ github.event.inputs.version }}**
          
          **Type:** ${{ github.event.inputs.release_type }}
          **Date:** ${{ github.run_id }}
          
          ### ğŸ“± Installation
          TÃ©lÃ©chargez l'APK ci-dessous et installez-le sur votre appareil.
          
          ### ğŸ”„ Mise Ã  jour automatique
          Si vous avez dÃ©jÃ  l'app installÃ©e, elle dÃ©tectera automatiquement cette mise Ã  jour.
        draft: false
        prerelease: ${{ github.event.inputs.release_type == 'nightly' }}
        files: |
          app/build/outputs/apk/stable/*.apk
          app/build/outputs/apk/nightly/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
